<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>1vs1 êµ¬ì¸ ê²Œì‹œíŒ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      max-width: 1100px;
      margin: 0 auto;
      padding: 16px;
      background: #f5f5f5;
    }
    h1 {
      text-align: center;
      margin-bottom: 16px;
    }

    /* 2ì—´ ë ˆì´ì•„ì›ƒ */
    .layout {
      display: flex;
      gap: 16px;
      align-items: flex-start;
      flex-wrap: wrap;
    }
    .col {
      flex: 1 1 340px;
      min-width: 0;
    }

    .card {
      background: #ffffff;
      border-radius: 8px;
      padding: 12px 16px;
      margin-bottom: 12px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    }

    /* ì¹´ë“œ í—¤ë” (ë‹‰ë„¤ì„ + ë°°ì§€ + X ë²„íŠ¼) */
    .post-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 8px;
    }
    .post-title-area h2 {
      margin: 0 0 4px;
      font-size: 18px;
    }

    .delete-btn {
      background: transparent;
      border: none;
      color: #9ca3af;
      font-size: 16px;
      cursor: pointer;
      padding: 0 4px;
      line-height: 1;
    }
    .delete-btn:hover {
      color: #ef4444;
    }

    .meta {
      font-size: 12px;
      color: #666;
      margin-bottom: 8px;
    }

    /* ë‹‰ë„¤ì„ ì•„ë˜ ê²Œì„í•  ì‹œê°„ í‘œì‹œ */
    .game-time {
      font-size: 15px;
      color: #2563eb;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .form-note {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 8px;
    }

    label {
      font-size: 13px;
      font-weight: 600;
      display: block;
      margin-top: 6px;
      margin-bottom: 2px;
    }
    .required-star {
      color: #ef4444;
      margin-left: 2px;
    }
    .optional-label {
      font-weight: 500;
      color: #6b7280;
      font-size: 12px;
      margin-left: 4px;
    }

    textarea, input[type="text"], input[type="password"] {
      width: 100%;
      box-sizing: border-box;
      padding: 8px;
      margin: 0 0 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-family: inherit;
      font-size: 14px;
    }
    button {
      padding: 6px 12px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      font-size: 14px;
    }
    button.primary {
      background: #2563eb;
      color: white;
    }
    button.danger {
      background: #ef4444;
      color: white;
    }
    button[disabled] {
      background: #9ca3af;
      cursor: default;
    }
    .post-body {
      white-space: pre-wrap;
      margin-bottom: 8px;
    }
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      margin-left: 4px;
    }
    .badge-open {
      background: #dcfce7;
      color: #166534;
    }
    .badge-closed {
      background: #fee2e2;
      color: #991b1b;
    }
    .comments {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid #e5e7eb;
      font-size: 13px;
    }
    .comment {
      margin-bottom: 4px;
    }
    .comment .author {
      font-weight: 600;
    }
    .comment-form {
      margin-top: 8px;
    }
    .small {
      font-size: 12px;
      color: #666;
    }

    .toggle-comments-btn {
      margin-top: 4px;
      font-size: 12px;
      background: #e5e7eb;
      color: #111827;
    }

    /* ëŒ“ê¸€ í—¤ë” (ê°œìˆ˜ë§Œ ìœ„ì— í‘œì‹œ) */
    .comments-header {
      margin-top: 4px;
      margin-bottom: 0;
    }
    .comment-count {
      font-size: 12px;
      color: #6b7280;
    }

    /* ë§ˆê° ë²„íŠ¼ ì˜¤ë¥¸ìª½ ì •ë ¬ */
    .post-actions {
      margin-top: 4px;
      text-align: right;
    }

    /* ì¹´ë“œ ë§¨ ì•„ë˜ ì˜¤ë¥¸ìª½ ì‘ì„± ì‹œê°„ */
    .footer-meta {
      margin-top: 4px;
      text-align: right;
    }
    .footer-meta .small {
      font-size: 11px;
      color: #9ca3af;
    }

    @media (max-width: 700px) {
      .layout {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <h1>1vs1 êµ¬ì¸ ê²Œì‹œíŒ</h1>

  <div class="layout">
    <!-- ì™¼ìª½: ê¸€ ì‘ì„± í¼ -->
    <div class="col">
      <div class="card">
        <h2>ìƒˆ ê¸€ ì“°ê¸°</h2>
        <div class="form-note">
          <span class="required-star">*</span> í‘œì‹œëœ í•­ëª©ì€ í•„ìˆ˜ ì…ë ¥ì…ë‹ˆë‹¤.
        </div>
        <form id="post-form" autocomplete="off">
          <label for="post-nickname">
            ë‹‰ë„¤ì„<span class="required-star">*</span>
          </label>
          <input
  type="text"
  id="post-nickname"
  placeholder="ì˜ˆ: dozyê´´ë¬¼"
  autocomplete="new-password"
  required
/>


          <label for="post-password">
            ë¹„ë°€ë²ˆí˜¸<span class="required-star">*</span>
            <span class="optional-label">(ë§ˆê°/ì‚­ì œ/í™•ì¸ìš©, 4ìë¦¬ ìˆ«ì ì¶”ì²œ)</span>
          </label>
          <input
  type="password"
  id="post-password"
  placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
  autocomplete="new-password"
  required
/>


          <label for="post-title">
            ê²Œì„í•  ì‹œê°„<span class="required-star">*</span>
          </label>
          <input
  type="text"
  id="post-title"
  placeholder="ì˜ˆ: ì§€ê¸ˆ ë‹¹ì¥ / ì˜¤í›„ 10ì‹œë¶€í„°"
  autocomplete="new-password"
  required
/>

          <label for="post-body">
            ë©”ëª¨
            <span class="optional-label">(ì„ íƒ)</span>
          </label>
          <textarea
            id="post-body"
            rows="4"
            placeholder="í•˜ê³  ì‹¶ì€ ë§, ìº ë£¨ ë“± ì›í•˜ëŠ” ê²ƒë“¤ ì ìœ¼ì‹œë©´ ë©ë‹ˆë‹¤."
          ></textarea>

          <button class="primary" type="submit">ë“±ë¡</button>
        </form>
      </div>
    </div>

    <!-- ì˜¤ë¥¸ìª½: ê¸€ ëª©ë¡ -->
    <div class="col">
      <div id="post-list"></div>
    </div>
  </div>

  <!-- Supabase JS -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    // ğŸ”§ ë„ˆì˜ Supabase ê°’
    const SUPABASE_URL = "https://dijlvoxqmpiyxtmlqgtu.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRpamx2b3hxbXBpeXh0bWxxZ3R1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUzOTYzMjcsImV4cCI6MjA4MDk3MjMyN30.2m3aNwUzz4FhYImjayDPPFYpPQih14BkTIIyDMWu8bc";

    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ê¸€ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° + 06ì‹œ ê¸°ì¤€ / ë§ˆê° 3ì‹œê°„ í•„í„°ë§
    async function loadPosts() {
      const listEl = document.getElementById("post-list");
      listEl.innerHTML = "<div class='card'>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>";

      const { data, error } = await supabaseClient
        .from("solo_posts")
        .select("*")
        .order("created_at", { ascending: false });

      if (error) {
        console.error(error);
        listEl.innerHTML = "<div class='card'>ê¸€ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>";
        return;
      }

      if (!data || data.length === 0) {
        listEl.innerHTML = "<div class='card'>ì•„ì§ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ê¸€ì„ ì‘ì„±í•´ ë³´ì„¸ìš”!</div>";
        return;
      }

      const now = new Date();

      // ë§ˆì§€ë§‰ 06:00 ê³„ì‚° (ì§€ê¸ˆì´ 06ì‹œ ì´ì „ì´ë©´ ì–´ì œ 06:00, ì´í›„ë©´ ì˜¤ëŠ˜ 06:00)
      let resetBase = new Date();
      resetBase.setHours(6, 0, 0, 0);
      if (now < resetBase) {
        resetBase.setDate(resetBase.getDate() - 1);
      }

      listEl.innerHTML = "";
      for (const post of data) {
        const created = new Date(post.created_at);
        let visible = true;

        // 1) ë§ˆì§€ë§‰ 06:00 ì´ì „ì— ì“´ ê¸€ì€ ì•ˆ ë³´ì´ê²Œ
        if (created < resetBase) {
          visible = false;
        }

        // 2) ë§ˆê°ëœ ê¸€ì€ ë§ˆê° í›„ 3ì‹œê°„ê¹Œì§€ë§Œ ë³´ì´ê²Œ
        if (visible && post.closed) {
          if (!post.closed_at) {
            visible = false;
          } else {
            const closedAt = new Date(post.closed_at);
            const diffMs = now - closedAt;
            const threeHoursMs = 3 * 60 * 60 * 1000;
            if (diffMs > threeHoursMs) {
              visible = false;
            }
          }
        }

        if (!visible) continue;

        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div class="post-header">
            <div class="post-title-area">
              <h2>
                ${escapeHtml(post.nickname)}
                ${
                  post.closed
                    ? "<span class='badge badge-closed'>ë§ˆê°ë¨</span>"
                    : "<span class='badge badge-open'>ëª¨ì§‘ì¤‘</span>"
                }
              </h2>
            </div>
            <button
              class="delete-btn"
              title="ê¸€ ì‚­ì œ"
              onclick="deletePost(${post.id})"
            >
              Ã—
            </button>
          </div>
          <div class="game-time">
            ${escapeHtml(post.title)}
          </div>
          <div class="post-body">${escapeHtml(post.body || "")}</div>
          <div class="post-actions">
            ${
              post.closed
                ? "<button class='danger' disabled>ë§ˆê°ë¨</button>"
                : `<button class='danger' onclick="closePost(${post.id})">ì´ ê¸€ ë§ˆê°í•˜ê¸°</button>`
            }
          </div>
          <div class="comments-section">
            <div class="comments-header">
              <span
                id="comment-count-${post.id}"
                class="comment-count"
              >
                ëŒ“ê¸€ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
              </span>
            </div>
            <button
              type="button"
              class="toggle-comments-btn"
              id="toggle-comments-${post.id}"
              onclick="toggleComments(${post.id})"
            >
              ëŒ“ê¸€ ë³´ê¸°
            </button>
            <div id="comments-container-${post.id}" class="comments" style="display:none">
              <div id="comments-${post.id}" class="comments-list">
                ëŒ“ê¸€ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
              </div>
              <form class="comment-form" onsubmit="handleCommentSubmit(event, ${post.id})">
                <input type="text" name="nickname" placeholder="ë‹‰ë„¤ì„" required />
                <input type="text" name="content" placeholder="ëŒ“ê¸€ ë‚´ìš©" required />
                <button type="submit">ëŒ“ê¸€ ë“±ë¡</button>
              </form>
            </div>
          </div>
          <div class="footer-meta">
            <span class="small">${formatDate(post.created_at)}</span>
          </div>
        `;
        listEl.appendChild(card);

        loadComments(post.id);
      }

      if (!listEl.hasChildNodes()) {
        listEl.innerHTML = "<div class='card'>í˜„ì¬ í‘œì‹œí•  ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>";
      }
    }

    // ëŒ“ê¸€ ì ‘ê¸°/í¼ì¹˜ê¸°
    function toggleComments(postId) {
      const container = document.getElementById(`comments-container-${postId}`);
      const btn = document.getElementById(`toggle-comments-${postId}`);
      if (!container || !btn) return;

      const isHidden =
        container.style.display === "none" || container.style.display === "";
      container.style.display = isHidden ? "block" : "none";
      btn.textContent = isHidden ? "ëŒ“ê¸€ ì ‘ê¸°" : "ëŒ“ê¸€ ë³´ê¸°";
    }

    // ëŒ“ê¸€ ë¶ˆëŸ¬ì˜¤ê¸° + ê°œìˆ˜ í‘œì‹œ
    async function loadComments(postId) {
      const commentsEl = document.getElementById(`comments-${postId}`);
      const countEl = document.getElementById(`comment-count-${postId}`);
      if (!commentsEl) return;

      const { data, error } = await supabaseClient
        .from("solo_comments")
        .select("*")
        .eq("post_id", postId)
        .order("created_at", { ascending: true });

      if (error) {
        console.error(error);
        commentsEl.innerHTML = "<div>ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>";
        if (countEl) countEl.textContent = "ëŒ“ê¸€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨";
        return;
      }

      if (!data || data.length === 0) {
        commentsEl.innerHTML = "<div class='small'>ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>";
        if (countEl) countEl.textContent = "ëŒ“ê¸€ 0ê°œ";
        return;
      }

      commentsEl.innerHTML = "";
      for (const c of data) {
        const div = document.createElement("div");
        div.className = "comment";
        div.innerHTML = `
          <span class="author">${escapeHtml(c.nickname)}</span>:
          <span>${escapeHtml(c.content)}</span>
          <span class="small"> (${formatTime(c.created_at)})</span>
        `;
        commentsEl.appendChild(div);
      }

      if (countEl) countEl.textContent = `ëŒ“ê¸€ ${data.length}ê°œ`;
    }

    // ëŒ“ê¸€ ë“±ë¡
    async function handleCommentSubmit(event, postId) {
      event.preventDefault();
      const form = event.target;
      const nickname = form.nickname.value.trim();
      const content = form.content.value.trim();
      if (!nickname || !content) return;

      const { error } = await supabaseClient
        .from("solo_comments")
        .insert({
          post_id: postId,
          nickname: nickname,
          content: content
        });

      if (error) {
        console.error(error);
        alert("ëŒ“ê¸€ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        return;
      }

      form.reset();
      loadComments(postId);
    }

    // ê¸€ ë§ˆê° (ë¹„ë°€ë²ˆí˜¸ í™•ì¸ + closed_at ì €ì¥)
    async function closePost(postId) {
      const pw = prompt("ì´ ê¸€ì„ ë§ˆê°í•˜ë ¤ë©´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
      if (pw === null) return; // ì·¨ì†Œ
      const trimmed = pw.trim();
      if (!trimmed) {
        alert("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
        return;
      }

      const nowIso = new Date().toISOString();

      const { error, count } = await supabaseClient
  .from("solo_posts")
  .update({ closed: true, closed_at: nowIso })
  .eq("id", postId)
  .eq("password", trimmed)
  .select("*", { count: "exact" });

if (error) {
  console.error(error);
  alert("ë§ˆê° ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
  return;
}

if (count === 0) {
  alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
  return;
}


      if (error) {
        console.error(error);
        alert("ë§ˆê° ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        return;
      }

      if (!data || data.length === 0) {
        alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        return;
      }

      loadPosts();
    }

    // ê¸€ ì‚­ì œ (ì†Œí”„íŠ¸ ì‚­ì œ: ë°”ë¡œ í™”ë©´ì—ì„œ ì•ˆ ë³´ì´ê²Œ)
    async function deletePost(postId) {
      const pw = prompt(
        "ì´ ê¸€ì„ ì‚­ì œí•˜ë ¤ë©´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.\nì‚­ì œí•˜ë©´ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
      );
      if (pw === null) return; // ì·¨ì†Œ
      const trimmed = pw.trim();
      if (!trimmed) {
        alert("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
        return;
      }

      // ğŸ”¹ í˜„ì¬ ì‹œê°ë³´ë‹¤ 4ì‹œê°„ ì „ìœ¼ë¡œ closed_at ì„ ê°•ì œë¡œ ë³´ë‚´ë²„ë¦¬ê¸° (3ì‹œê°„ í•„í„°ì— ë°”ë¡œ ê±¸ë¦¬ê²Œ)
      const closedAtPast = new Date(
        Date.now() - 4 * 60 * 60 * 1000
      ).toISOString();

      // ë¹„ë°€ë²ˆí˜¸ê°€ ë§ëŠ” ê¸€ë§Œ "ì‚­ì œëœ ìƒíƒœ"ë¡œ ì—…ë°ì´íŠ¸
      const { data, error } = await supabaseClient
        .from("solo_posts")
        .update({
          closed: true,
          closed_at: closedAtPast
        })
        .eq("id", postId)
        .eq("password", trimmed)
        .select("id");

      if (error) {
        console.error(error);
        alert("ì‚­ì œ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        return;
      }

      if (!data || data.length === 0) {
        alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        return;
      }

      alert("ê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
      loadPosts(); // ğŸ”¹ í•„í„° ë•Œë¬¸ì— ë°”ë¡œ í™”ë©´ì—ì„œ ì‚¬ë¼ì§
    }

    // ê¸€ ì‘ì„± í¼ ì´ë²¤íŠ¸
    document.getElementById("post-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const nicknameInput = document.getElementById("post-nickname");
      const passwordInput = document.getElementById("post-password");
      const titleInput = document.getElementById("post-title");
      const bodyInput = document.getElementById("post-body");

      const nickname = nicknameInput.value.trim();
      const password = passwordInput.value.trim();
      const title = titleInput.value.trim();
      const body = bodyInput.value.trim(); // ë©”ëª¨ëŠ” ë¹„ì–´ ìˆì–´ë„ ë¨

      // ìœ„ ì„¸ ê°œë§Œ í•„ìˆ˜
      if (!nickname || !password || !title) {
        alert("ë‹‰ë„¤ì„, ë¹„ë°€ë²ˆí˜¸, ê²Œì„í•  ì‹œê°„ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.");
        return;
      }

      const { error } = await supabaseClient
        .from("solo_posts")
        .insert({
          nickname: nickname,
          password: password,
          title: title,
          body: body
        });

      if (error) {
        console.error(error);
        alert("ê¸€ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        return;
      }

      nicknameInput.value = "";
      passwordInput.value = "";
      titleInput.value = "";
      bodyInput.value = "";
      loadPosts();
    });

    // HTML escape
    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function formatDate(iso) {
      const d = new Date(iso);
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      const hh = String(d.getHours()).padStart(2, "0");
      const mm = String(d.getMinutes()).padStart(2, "0");
      return `${y}-${m}-${day} ${hh}:${mm}`;
    }

    function formatTime(iso) {
      const d = new Date(iso);
      const hh = String(d.getHours()).padStart(2, "0");
      const mm = String(d.getMinutes()).padStart(2, "0");
      return `${hh}:${mm}`;
    }

    loadPosts();
  </script>
</body>

</html>




